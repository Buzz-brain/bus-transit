<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Link to Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <!-- dashboard.html -->
    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Passenger Count Dashboard</title>
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet">
        <style>
            #map {
                width: 100%;
                height: 500px;
            }
        </style>
    </head>

    <body>
        <h1>Passenger Count Dashboard</h1>
        <div id="map"></div>

        <!-- Leaflet JavaScript library -->
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <script>
            // Set initial map center coordinates (longitude and latitude)
            const longitude = -74.006; // Replace with actual longitude
            const latitude = 40.7128;  // Replace with actual latitude
            const longitude1 = -74.306; // Approximately 2 miles east
            const latitude1 = 40.8328;
            const longitude2 = -73.586; // Approximately 1 mile west
            const latitude2 = 40.6928; // Approximately 1 mile south


            // Initialize map
            const map = L.map('map').setView([latitude, longitude], 10); // Replace latitude and longitude with initial center coordinates

            // Load and display OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);



            // Define bus stops with names and coordinates
            const busStops = [
                { name: "Eziobodo", coords: [latitude, longitude] },
                { name: "Ihiagwa", coords: [latitude1, longitude1] },
                { name: "Umuchima", coords: [latitude2, longitude2] },
                // Add more bus stops with coordinates
            ];

            // Add markers for each bus stop on the map
            const markers = busStops.map(stop => {
                const color = stop.count > 20 ? "red" : stop.count > 10 ? "yellow" : "green";

                const marker = L.marker(stop.coords, {
                    icon: L.divIcon({
                        className: `marker-icon-${color}`,
                        html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%;"></div>`
                    })
                }).addTo(map);

                // Bind a tooltip that shows the stop name and passenger count without clicking
                marker.bindTooltip(
                    `<strong>${stop.name}</strong><br>Passenger Count: ${stop.count}`,
                    { permanent: true, direction: "top", offset: [0, -10] }
                );

                marker.stopName = stop.name;
                return marker;
            });


            // Connect to the socket
            const socket = io();

            // Listen for passenger count updates
            socket.on("updateCount", (data) => {
                // Update your dashboard with the received count
                data.forEach(update => {
                    const marker = markers.find(m => m.stopName === update.stopName);

                    console.log('Received update count:', update.count, update.stopName);

                    if (marker) {
                        // Update color based on count
                        const color = update.count > 20 ? "red" : update.count > 10 ? "yellow" : "green";
                        marker.setIcon(L.divIcon({
                            className: `marker-icon-${color}`,
                            html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%;"></div>`
                        }));
                        // Update tooltip content to reflect new passenger count
                        marker.setTooltipContent(`<strong>${update.stopName}</strong><br>Passenger Count: ${update.count}`);
                    }
                });
            });
        </script>
    </body>

    </html>

    <!-- <script>
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Please log in first.");
                window.location.href = "/login.html";
            } else {
                fetch("/api/protected/dashboard", {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            document.getElementById("dashboardMessage").innerText = data.message;
                        } else {
                            alert("Session expired. Please log in again.");
                            localStorage.removeItem("token");
                            window.location.href = "/login.html";
                        }
                    })
                    .catch(error => console.error("Error loading dashboard:", error));
            }
        });

        // Emit passenger count updates to all connected clients

        setInterval(() => {
            const passengerData = [
                { stopName: "Stop 1", count: Math.floor(Math.random() * 30) },  // Example data
                { stopName: "Stop 2", count: Math.floor(Math.random() * 30) },
            ];
            io.emit("passengerCountUpdate", passengerData);
        }, 1000);


    </script> -->